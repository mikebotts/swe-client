<!-- This Source Code Form is subject to the terms of the Mozilla Public
   - License, v. 2.0. If a copy of the MPL was not distributed with this
   - file, You can obtain one at http://mozilla.org/MPL/2.0/. 
   -
   - Software distributed under the License is distributed on an "AS IS" basis,
   - WITHOUT WARRANTY OF ANY KIND, either express or implied. See the License
   - for the specific language governing rights and limitations under the License.
   -
   - The Initial Developer is Terravolv, Inc. Portions created by the Initial
   - Developer are Copyright (C) 2014-2015 the Initial Developer. All Rights Reserved. -->
<!DOCTYPE html>
<html lang="en" >
<head>
  <meta charset="utf-8" />
  <meta name="author" content="Open Sensor Hub" />
  <title>Open Sensor Hub Client Configuration</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <link rel="resource" type="application/l10n" href="locales/locales.ini" />
  <script src="js/l10n.js"></script>
  <link rel="stylesheet" href="//cdnjs.cloudflare.com/ajax/libs/jstree/3.1.0/themes/default/style.min.css" />
  <link rel="stylesheet" href="css/jquery.webui-popover.css">
  <link href="assets/css/bootstrap.min.css" rel="stylesheet">
  <link type="text/css" href="css/custom-theme/jquery-ui-1.10.0.custom.css" rel="stylesheet" />
  <link type="text/css" href="assets/css/font-awesome.min.css" rel="stylesheet" />
  <link href="assets/css/docs.css" rel="stylesheet">
  <link href="assets/js/google-code-prettify/prettify.css" rel="stylesheet">

  <script src="//code.jquery.com/jquery-1.11.2.min.js"></script>
  <!--  <script src="//code.jquery.com/ui/1.11.4/jquery-ui.js"></script> -->
  <script src="js/jquery.webui-popover.js"></script>
  <script src="js/sQuery.js"></script>
  <script src="//cdnjs.cloudflare.com/ajax/libs/jstree/3.1.0/jstree.min.js"></script> 
  <script src="js/math.uuid.js"></script>
  <script src="js/configuration.js"></script>
  
</head>
<body data-spy="scroll" data-target=".bs-docs-sidebar" data-twttr-rendered="true">
  <!-- Navbar -->
  <div class="navbar navbar-inverse navbar-fixed-top">
      <div class="navbar-inner">
          <div class="container">
              <button type="button" class="btn btn-navbar" data-toggle="collapse" data-target=".nav-collapse">
                  <span class="icon-bar"></span>
                  <span class="icon-bar"></span>
                  <span class="icon-bar"></span>
              </button>
              <a class="brand" href="#">Open Sensor Hub</a>
              <div class="nav-collapse collapse">
                  <ul class="nav">
                      <li class="active">
                          <a href="./capabilities.html">Home</a>
                      </li>
                      <li>
                          <a href="./index.html">Client Library</a>
                      </li>
                      <li>
                          <a href="./capabilities.html">Server Capabilities</a>
                      </li>
                      <li>
                          <a href="https://github.com/mikebotts">Contact</a>
                      </li>
                  </ul>
              </div>
          </div>
      </div>
  </div>
  <!-- Subhead -->
  <header class="jumbotron subhead" id="overview">
      <div class="container">
          <h1>Open Sensor Hub Client Configuration</h1>
          <p class="lead">Configuring Client Data Items</p>
      </div>
  </header>
  <div class="container">
    <div class="row">
        <div class="span12">
        <div class="row-fluid">
          <h1>1. Overview</h1>
          <p class="docs-lead">
            Welcome! On this site you can configure the data items you want to incorporate into your SOS application.  The data items configured here
            will be stored and accessible in your application.  So, what is a data item?  In the SOS language, a data item is essentially an observable property.
            A SOS server can have multiple offerings.  In the SOS, observations are grouped into layers per each sensor system. These layers are 
            called ObservationOffering (or short: offering).  An offering may contain multiple observable properties.  
          </p>
        </div>
        <div class="alert alert-info">
            <span class="icon-info-sign"></span> Sensor Systems <strong>have</strong> offering<strong>(s)</strong>, and offerings <strong>have</strong> observable propert<strong>y/(ies)</strong>.
        </div>              
        <div class="row-fluid">
          <p class="docs-lead">
            Data items are typically organized into a parent-child hierarchy, essentially tree views!  A data item may reside within one or more parents 
            in the tree.  This site provides the ability to create your organization tree without requiring you to associate SOS observable properties to 
            them, although you may associate observables as you create the tree.  Once you have organized your tree as you desire, you can associate them 
            to the desired observable property.
          </p>
        </div>
        <div class="row-fluid">
          <h1>2. Configuration</h1>
        </div>
      </div>
    </div>
  </div>

  <div class="container">
    <div class="row">
        <div class="span4 bs-docs-sidebar">
          <div class="row-fluid">
              <p class="docs-lead">
                Freely organize your data items using the tree below. Then navigate the SOS server capabilities using the panel to your right and 
                associate the desired observable property to your data item.
              </p>
              <p class="docs-lead">
                <button id="btnSaveTree" class="ui-button-primary">Save Configuration</button>
                <button id="btnShowTree" class="ui-button-primary">Print Tree</button>

                <div id="tooltip">
                  <div id="tree">
                  </div>
                </div>
              </p>
          </div>
        </div>        

        <div class="span8">
        <div class="row-fluid">
            <p class="docs-lead">
              Select or add a SOS server to navigate it's capabilities and determine the offering and observable property that you want to 
              associate with a data item in your tree.  Then click the associate button.
            </p>
        </div>
        <div class="row-fluid">
            <p class="docs-lead">
              <p class="docs-lead">
                <select id = "offServers" class="baseurl">
                 <option value = "">Select a SOS Server</option>
                 <option value = "http://bottsgeo.com:8181/sensorhub">Mike's Server [http://bottsgeo.com:8181/sensorhub] </option>
                 <option value = "http://ec2-52-16-177-252.eu-west-1.compute.amazonaws.com:8181/sensorhub">Alex's Server [http://ec2-52-16-177-252.eu-west-1.compute.amazonaws.com:8181/sensorhub]</option>
                </select>
                <button id="btnAddSOSServer" class="ui-button-primary">Add Server</button>
              </p>
              <p class="docs-lead">
                <label for="offerings">Offerings: </label>
                <select id="offerings" class="serviceident"></select>
                <label for="offIdentifier">Identifier: </label>
                <input type="text" id="offIdentifier" class="serviceident">
                <label for="offDescription">Description: </label>
                <input type="text" id="offDescription" class="serviceident">
                <label for="offProcedure">Procedure: </label>
                <input type="text" id="offProcedure" class="serviceident">
                <label for="offObservables">Observables: </label>
                <select id="offObservables" class="serviceident"></select>
                <button id="btnAssociateDataItem" class="ui-button-primary">Associate to selected Data Item</button>
                <label for="offPhenonmenonTime">Phenomenon Time: </label>
                <select id="offPhenonmenonTime" class="serviceident"></select>          
                <label for="offPhenonmenonTimeBegin">Begin Time: </label>
                <input type="text" id="offPhenonmenonTimeBegin" class="serviceident">
                <label for="offPhenomenonIndeterminateTime">Indeterminate Time: </label>
                <input type="text" id="offPhenomenonIndeterminateTime" class="serviceident">
                <label for="offPhenomenonEndBegin">End Time: </label>
                <input type="text" id="offPhenomenonEndBegin" class="serviceident">
                <label for="grtemporalfilter">Time filter (for getting result URL): </label>
                <input type="text" id="grtemporalfilter" placeholder="Now/2020-01-01" class="serviceident">
              </p>
            </p>
            <div id="addserverdialog" title="Server Data">
                <form>
                    <fieldset class="ui-helper-reset">
                        <label for="display_name">Display Name</label>
                        <input type="text" name="display_name" id="display_name" value="" class="ui-widget-content ui-corner-all" />
                        <label for="server_baseurl">Base URL</label>
                        <input type="text" name="server_baseurl" placeholder="http://server/alias" id="server_baseurl" value="" class="ui-widget-content ui-corner-all" />
                    </fieldset>
                </form>
            </div>
      </div>
    </div>
    </div>
  </div>
<!-- Footer -->
<footer class="footer">
  <div class="container">
    <p>
        Open Sensor Hub &copy; 2014 - 2015.
    </p>
  </div>
</footer>  
<script src="assets/js/bootstrap.min.js" type="text/javascript"></script>
<script src="assets/js/jquery-ui-1.10.0.custom.min.js" type="text/javascript"></script>
<script src="assets/js/google-code-prettify/prettify.js" type="text/javascript"></script>
<script src="assets/js/docs.js" type="text/javascript"></script>
<script src="assets/js/demo.js" type="text/javascript"></script>
<script src="js/moment.min.js" type="text/javascript"></script>
<script>
$(function() {

	if("undefined" !== typeof(Storage) ) {
	
		// Get saved data items
		var _DI = localStorage.getItem("sosDataItems");

    // _DI = '[{"id":"440ecdb0-d2a9-ea62-37de-fe78c30b3b1e","text":"Data Items","icon":true,"li_attr":{"id":"440ecdb0-d2a9-ea62-37de-fe78c30b3b1e"},"a_attr":{"href":"#","id":"440ecdb0-d2a9-ea62-37de-fe78c30b3b1e_anchor"},"state":{"loaded":true,"opened":true,"selected":false,"disabled":false},"data":{"0":{"key":"created","value":"' + moment().format() + '"}},"children":[]}]';
      
		if ((undefined === _DI) || (null === _DI)) {
			// Add root data item node if no data items found
			//console.log("Adding root data item.");
			_DI = '[{"id":"440ecdb0-d2a9-ea62-37de-fe78c30b3b1e","text":"Data Items","icon":true,"li_attr":{"id":"440ecdb0-d2a9-ea62-37de-fe78c30b3b1e"},"a_attr":{"href":"#","id":"440ecdb0-d2a9-ea62-37de-fe78c30b3b1e_anchor"},"state":{"loaded":true,"opened":true,"selected":false,"disabled":false},"data":{"0":{"key":"created","value":"' + moment().format() + '"}},"children":[]}]';
			localStorage.setItem("sosDataItems",_DI);
		} 
		
		var jsTreeFormat = JSON.parse(_DI, function(k, v) {
			if (k === "parentid") {
				this.parent = (v) ? v : '#';
			} else if (k === "name") {
				this.text = v;
			} else {
				return v;
			}
		});

		$('#tree').jstree(  { 'core' : {'check_callback' :  function (op, node, par, pos, more) {
                                                          if ( more && more.dnd && (op === 'move_node' || op === 'copy_node') && (par.id === "#")) {
                                                            // Don't allow moving before the root node (Data Items)
                                                            return false;
                                                          }
                                                          return true;
                                                        },
                                    'multiple' : false,
                                    'data' : jsTreeFormat }, 
                          'dnd': { check_while_dragging: true /* You need this or check_callback will not be called when moving nodes */},                          
                          'plugins' : ['contextmenu','dnd'],
                          'contextmenu' : { 'items' : function(node) {
                                                        var tmp = $.jstree.defaults.contextmenu.items();
                                                        delete tmp.create.action;
                                                        tmp.create.label = "New Data Item";
                                                        tmp.create.action = function (data) {
                                                                              var inst = $.jstree.reference(data.reference),
                                                                                  obj = inst.get_node(data.reference);
                                                                              inst.create_node( obj, 
                                                                                                { type : "default", 
                                                                                                  id: Math.uuid().toLowerCase(),
                                                                                                  data : { "0" : {"key"   : "created",
                                                                                                                  "value" : moment().format()
                                                                                                           },
                                                                                                           "1" : {"key"   : "parentid",
                                                                                                                  "value" : obj.id
                                                                                                           },
                                                                                                           "2" : {"key"   : "moved",
                                                                                                                  "value" : null
                                                                                                           },
                                                                                                           "3" : {"key"   : "oldparentid",
                                                                                                                  "value" : null
                                                                                                           },
                                                                                                           "4" : { "key"  : "observables",
                                                                                                                   "value" : {}
                                                                                                           }
                                                                                                         }    
                                                                                                }, 
                                                                                                "last", 
                                                                                                function (new_node) {
                                                                                                  // Allow to edit the name of new node    
                                                                                                  setTimeout(function () { inst.edit(new_node); },0);
                                                                                                }
                                                                                              )
                                                                            };
                                                        return tmp;
                                                      }
                                          },
                        } );

                         
    $('#tree').on('move_node.jstree', function(e, data) {
      console.log(data);
      // Extract into separate variables for ease of following
      var oldParentId = data.old_parent;
      var newParentId = data.parent;
      var me = data.node;  // This is me!  I just moved!
      var mydata = me.data; // Get my collection of objects that have <key, value> pairs.
      for (var i in mydata) {
        // Just in case some other code touched my collection object!
        if (mydata.hasOwnProperty(i)) { 
          switch (mydata[i]['key']) {
            case "moved":
              mydata[i]['value'] = moment().format();
              break;
            case "parentid":
              mydata[i]['value'] = newParentId;
              break;
            case "oldparentid":
              mydata[i]['value'] = oldParentId;
              break;
          }
        }
      }
    });
    
    $('#tree').on('hover_node.jstree',function(e,data){
      //$("#"+data.node.id).prop('title', "add your custom title here");
      //console.log("Hover");
      console.log(data.node.text);
      $("#"+data.node.id).webuiPopover({title:data.node.text,content:'Content'});
    })    

		$("#btnShowTree").button().click(function(){
			var st = $("#tree").jstree(true).get_json();
			console.log(st);
		});
    
    /*
		$("#btnAddSOSServer").button().click(function(){
			var st = $("#tree").jstree(true).get_json();
			console.log(st);
			var st1 = JSON.stringify(st);
			console.log(st1);
			var arr_from_json = JSON.parse(st1);
			console.log(arr_from_json);
		});
    */

		$("#btnAssociateDataItem").button().click(function(){

      if (undefined === $("#offIdentifier").val().trim() || !$("#offIdentifier").val().trim()) {
        alert( "Identifier must be set." );
        return;
      }

      if (undefined === $("#grtemporalfilter").val().trim() || !$("#grtemporalfilter").val().trim()) {
        alert( "Time filter must be supplied." );
        return;
      }

      var templateurl = S($("#offServers option:selected").val())
                    .getresulttemplateurl($("#offIdentifier").val(), 
                                          $("#offObservables option:selected").text());
      
      var wsurl = S($("#offServers option:selected").val())
                .getresultwsurl($("#offIdentifier").val(), 
                                $("#offObservables option:selected").text(),
                                $("#grtemporalfilter").val());
      
      // Get the select data item from tree
      var selectedNode= $('#tree').jstree(true).get_selected(true);

      console.log(selectedNode);

      var mydata = selectedNode[0].data; // Get my collection of objects that have <key, value> pairs.

      for (var i in mydata) {

      // Just in case some other code touched my collection object!
        if (mydata.hasOwnProperty(i)) {

          if (mydata[i]['key'] === "observables") {
          
            if (null === mydata[i]['value']) 
              mydata[i]['value'] = {};

            // Save the template URL and feed URL for the current observable
            var observableProperty = new Object();
            observableProperty.tempateurl = templateurl;
            observableProperty.dataurl = wsurl;
            mydata[i]['value'][Object.keys(mydata[i]['value']).length+1] =  observableProperty;
            
            break;
          }        
        }
      }
		});
    
		$("#btnSaveTree").button().click(function(){
			var _DI = JSON.stringify($("#tree").jstree(true).get_json());
			localStorage.setItem("sosDataItems",_DI);
      console.log("Data items saved.")
		});

		
	} else {
		throw new Error("Local storage not supported.");
	}  

});

</script>
</body>
</html>
